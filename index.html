<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="theme-color" content="#0a0a0c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FlipMaster 7">
    <title>FlipMaster 7</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23111'/><rect x='5' y='5' width='90' height='90' rx='15' stroke='%23ffcc00' stroke-width='3' fill='none'/><text x='50' y='70' font-family='sans-serif' font-weight='900' font-size='60' text-anchor='middle' fill='%23ffcc00'>7</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23000'/><rect x='5' y='5' width='90' height='90' rx='18' stroke='%23ffcc00' stroke-width='4' fill='%231a1a1a'/><text x='50' y='70' font-family='sans-serif' font-weight='900' font-size='60' text-anchor='middle' fill='%23ffcc00'>7</text></svg>">

    <style>
        :root { 
            --gold: #ffcc00; --bg: #0a0a0c; --card-bg: rgba(30, 30, 35, 0.85); 
            --text: #fff; --subtext: #aaa; 
            --f7-purple: #9c27b0; --bust-red: #ff4444; --bonus-green: #00e676;
            
            /* NEON Card Colors */
            --c12: #ff2a2a; --c11: #ff9100; --c10: #ffd600; --c9: #00e676; --c8: #2979ff;
            --c7: #d500f9; --c6: #f50057; --c5: #00bfa5; --c4: #8d6e63; --c3: #78909c;
            --c2: #bdbdbd; --c1: #ffffff;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: radial-gradient(circle at top, #1a1a2e 0%, #0a0a0c 100%); 
            color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 15px; margin: 0; min-height: 100vh;
            padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
            overflow-x: hidden; user-select: none; -webkit-user-select: none;
        }

        /* --- LAYOUT & GLASS PANELS --- */
        .glass-panel { 
            background: var(--card-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            padding: 20px; border-radius: 24px; width: 100%; max-width: 480px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.08); box-sizing: border-box; 
        }

        .title-screen { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 85vh; }
        .hero-logo { width: 120px; height: 120px; border-radius: 30px; margin-bottom: 20px; box-shadow: 0 0 30px rgba(255, 204, 0, 0.3); border: 2px solid var(--gold); background: #111; display: flex; align-items: center; justify-content: center; font-size: 3rem; }
        
        /* --- BUTTONS --- */
        .menu-btn, .opt-btn, .tab-btn, .bust-btn, .token, .submit-btn, .toggle-btn, .dealer-marker, .slick-card {
            transition: all 0.1s; touch-action: manipulation; cursor: pointer;
        }
        .menu-btn:active, .opt-btn:active, .dealer-marker:active, .slick-card:active { transform: scale(0.95); filter: brightness(1.2); }

        .menu-btn { width: 100%; padding: 18px; margin: 10px 0; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-weight: 900; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; }
        .menu-btn.primary { background: var(--gold); color: #000; border: none; box-shadow: 0 0 20px rgba(255, 204, 0, 0.2); }
        .menu-btn.danger { border-color: rgba(255, 68, 68, 0.3); color: var(--bust-red); font-size: 0.8rem; margin-top: 30px; padding: 12px; }
        .menu-btn.secondary { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); }
        .menu-btn.warn { background: rgba(255, 68, 68, 0.15); border: 1px solid rgba(255, 68, 68, 0.5); color: var(--bust-red); }
        .menu-btn.install { background: #2979ff; border: none; box-shadow: 0 0 15px rgba(41, 121, 255, 0.4); display: none; }
        .menu-btn.coffee { border-color: #FFDD00; color: #FFDD00; background: rgba(255, 221, 0, 0.1); margin-top: 10px; font-size: 0.8rem; }

        .header-row { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 480px; margin-bottom: 10px; }
        h1 { color: var(--gold); margin: 0; font-size: 1rem; text-transform: uppercase; font-weight: 900; letter-spacing: 1px; text-shadow: 0 0 10px rgba(255, 204, 0, 0.3); }
        .reset-action-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 68, 68, 0.2); color: var(--bust-red); padding: 10px 20px; border-radius: 14px; font-size: 0.7rem; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; }

        .tab-container { display: flex; gap: 8px; margin-bottom: 20px; width: 100%; max-width: 480px; }
        .tab-btn { flex: 1; padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.05); color: var(--subtext); border: 1px solid rgba(255,255,255,0.1); font-size: 0.75rem; font-weight: bold; }
        .tab-btn.active { border-color: var(--gold); color: var(--gold); background: rgba(255, 204, 0, 0.1); }

        /* --- PLAYER ROW --- */
        .player-row { background: rgba(255, 255, 255, 0.03); margin-bottom: 15px; padding: 18px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        .leader { border: 1px solid var(--gold); box-shadow: 0 0 15px rgba(255, 204, 0, 0.1); }
        .score { font-size: 2.2rem; font-weight: 900; color: var(--gold); }
        .bonus-badge {
            background: rgba(0, 230, 118, 0.1); border: 1px solid var(--bonus-green); color: var(--bonus-green);
            padding: 4px 8px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; margin-left: 5px; cursor: pointer;
            box-shadow: 0 0 5px var(--bonus-green);
        }

        /* --- DEALER MARKER --- */
        .p-header { display: flex; justify-content: space-between; align-items: center; }
        .p-info { display: flex; align-items: center; gap: 10px; }
        .dealer-marker { 
            width: 28px; height: 28px; border-radius: 50%; 
            border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.3);
            color: #555; font-weight: bold; font-size: 0.8rem;
            display: flex; align-items: center; justify-content: center;
        }
        .dealer-marker.active {
            background: #fff; color: #000; border-color: #fff;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        .action-group { display: flex; gap: 8px; margin-top: 15px; }
        .opt-btn { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); color: var(--subtext); font-size: 0.7rem; font-weight: 800; }
        .active-x2 { background: var(--gold) !important; color: #000 !important; }
        .active-f7 { background: var(--f7-purple) !important; color: #fff !important; }
        .delete-btn { border-color: rgba(255, 68, 68, 0.5); background: rgba(255, 68, 68, 0.15); color: var(--bust-red); flex: 0.5; font-weight: 900; font-size: 1.2rem; }

        .is-busted-wrapper .player-row { filter: grayscale(1); opacity: 0.3; }
        .bust-btn { background: var(--bust-red); color: white; padding: 8px 16px; border-radius: 20px; border: none; font-weight: 900; text-transform: uppercase; font-size: 0.7rem; white-space: nowrap; }
        .undo-bust { background: rgba(255, 255, 255, 0.1) !important; color: var(--subtext) !important; border: 1px solid #444 !important; }

        /* --- CARD CSS (NEON) --- */
        .token-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 15px 0; }
        .slick-card {
            aspect-ratio: 2.5 / 3.5; border-radius: 12px;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 6px; position: relative; overflow: hidden;
            background-color: #111; border: 2px solid var(--c-bg);
            box-shadow: 0 0 5px var(--c-bg), inset 0 0 10px rgba(0,0,0,0.5);
        }
        .slick-card.number::before {
            content: ''; position: absolute; inset: 0;
            background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 10px 10px; pointer-events: none;
        }
        .slick-card.bonus {
            background: linear-gradient(135deg, var(--c-bg), #004d40);
            border: 2px solid rgba(255,255,255,0.8);
            box-shadow: 0 4px 10px rgba(0,0,0,0.6);
        }
        .slick-card.bonus .card-center, .slick-card.bonus .card-corner { color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .slick-card.number .card-center { color: var(--c-bg); font-size: 3.5rem; text-shadow: 0 0 10px var(--c-bg); }
        .slick-card.number .card-corner { color: var(--c-bg); font-weight: 800; font-size: 1rem; text-shadow: 0 0 5px var(--c-bg); }
        .card-center { font-size: 2.5rem; font-weight: 900; line-height: 1; align-self: center; z-index:2; margin-top: auto; margin-bottom: auto;}
        .card-corner { font-size: 0.9rem; font-weight: bold; line-height: 1; z-index:2; padding: 2px; }
        .card-corner.btm { align-self: flex-end; transform: rotate(180deg); }
        .bonus-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; }
        .bonus-row .slick-card { aspect-ratio: 2.5/3.5; --c-bg: var(--bonus-green); }
        .bonus-row .card-center { font-size: 1.6rem; }

        .submit-btn { background: var(--gold); color: #000; width: 100%; padding: 16px; border-radius: 16px; font-weight: 900; border: none; font-size: 1rem; margin-top: 15px; }

        /* --- UTILS --- */
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .toggle-btn { background: #333; color: #aaa; border: 1px solid #555; padding: 10px 20px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; min-width: 80px; }
        .toggle-btn.active { background: var(--gold); color: #000; border-color: var(--gold); }
        .rules-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; text-align: left; }
        .rule-card { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; font-size: 0.85rem; color: #ccc; }
        .rule-card b { color: var(--gold); display: block; margin-bottom: 4px; }

        /* --- CONFETTI CANVAS --- */
        #confetti-canvas { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 10002; display: none; }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); z-index: 10000; display: none; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .modal-overlay.show { display: flex !important; }
        .modal-box { background: #1e1e24; border: 2px solid var(--gold); border-radius: 20px; padding: 25px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 0 50px rgba(0,0,0,0.8); position: relative; z-index: 10001; max-height: 85vh; overflow-y: auto; }
        .modal-text { font-size: 1.2rem; font-weight: bold; color: #fff; margin-bottom: 25px; }
        .modal-actions { display: flex; gap: 15px; }
        .modal-btn { flex: 1; padding: 15px; border-radius: 12px; font-weight: bold; border: none; font-size: 1rem; cursor: pointer; }
        .btn-cancel { background: #333; color: #fff; border: 1px solid #555; }
        .btn-confirm { background: var(--gold); color: #000; }
        
        input[type="number"] { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 12px; border-radius: 12px; text-align: center; font-size: 1.1rem; -moz-appearance: textfield; width: 100%; max-width: 70px; }
        input[type="text"] { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 12px; border-radius: 12px; text-align: center; font-size: 1.1rem; -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .hidden { display: none !important; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #222; padding: 15px 25px; border-radius: 12px; border: 1px solid var(--gold); z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; color: var(--gold); font-weight: bold; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div id="confirm-modal" class="modal-overlay" onclick="resolveConfirm(false)">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div id="confirm-message" class="modal-text">Are you sure?</div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="resolveConfirm(false)">CANCEL</button>
                <button class="modal-btn btn-confirm" onclick="resolveConfirm(true)">CONFIRM</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay" onclick="closeSettings()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-text" style="color:var(--gold); font-size: 1.5rem;">Settings</div>
            <div class="setting-row">
                <div style="text-align:left;">
                    <div style="font-weight:bold;">Audio</div>
                    <small style="color:#666;">Sound effects</small>
                </div>
                <button id="sound-btn" class="toggle-btn" onclick="toggleSound()">OFF</button>
            </div>
            <div class="setting-row">
                <div style="text-align:left;">
                    <div style="font-weight:bold;">Haptics</div>
                    <small style="color:#666;">Vibrate on tap</small>
                </div>
                <button id="haptic-btn" class="toggle-btn" onclick="toggleHaptics()">OFF</button>
            </div>
            <div class="setting-row">
                <div style="text-align:left;">
                    <div style="font-weight:bold;">Keep Screen On</div>
                    <small style="color:#666;">Prevents phone sleeping</small>
                </div>
                <button id="wakelock-btn" class="toggle-btn" onclick="toggleWakeLock()">OFF</button>
            </div>
            <button class="menu-btn secondary" onclick="closeSettings()" style="margin-top:20px;">CLOSE</button>
        </div>
    </div>

    <div id="rules-modal" class="modal-overlay" onclick="closeRules()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-text" style="color:var(--gold); font-size: 1.5rem;">Rules & Odds</div>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:20px;">Goal: Reach 200 points. <br><span style="color:var(--gold)">Highest number = Most common!</span></p>
            <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px; margin-bottom:20px;">
                <div style="font-weight:bold; color:var(--gold); margin-bottom:5px;">NUMBER CARDS</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; font-size:0.8rem; text-align:left;">
                    <div>Value <b>12</b>: 12 cards</div>
                    <div>Value <b>11</b>: 11 cards</div>
                    <div>Value <b>10</b>: 10 cards</div>
                    <div>Value <b>9</b>: 9 cards</div>
                    <div>Value <b>8</b>: 8 cards</div>
                    <div>Value <b>7</b>: 7 cards</div>
                    <div>Value <b>6</b>: 6 cards</div>
                    <div>Value <b>5</b>: 5 cards</div>
                    <div>Value <b>4</b>: 4 cards</div>
                    <div>Value <b>3</b>: 3 cards</div>
                    <div>Value <b>2</b>: 2 cards</div>
                    <div style="color:var(--gold)">Value <b>1</b>: 1 card</div>
                </div>
            </div>
            <div class="rules-grid">
                <div class="rule-card"><b>Special Cards</b>Freeze, Flip 3, Second Chance (3 of each in deck).</div>
                <div class="rule-card"><b>Modifiers</b>+2, +4, +6, +8, +10 (1 of each).<br>x2 Multiplier (1 total).</div>
                <div class="rule-card"><b>Scoring Order</b>1. Sum Numbers<br>2. Multiply (x2)<br>3. Add Bonus Cards<br>4. Flip 7 Bonus (+15)</div>
                <div class="rule-card"><b>Flip 7</b>If you get 7 unique numbers, round ends immediately. +15 Pts.</div>
            </div>
            <button class="menu-btn secondary" onclick="closeRules()" style="margin-top:20px;">CLOSE</button>
        </div>
    </div>

    <div id="winner-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 400px; border-color: var(--gold);">
            <div style="font-size:4rem; margin-bottom: 10px;">üëë</div>
            <div id="winner-display-name" style="font-size: 2rem; color: var(--gold); font-weight: 900;">---</div>
            <p id="winner-score-display" style="color:#aaa; margin-bottom: 30px;">Winner!</p>
            <button class="menu-btn primary" onclick="startNewMatch()">RESET SCORES & REPLAY</button>
            <button class="menu-btn warn" onclick="undoWin()">UNDO</button>
            <button onclick="closeWinnerModal()" style="background:transparent; color:#888; width:100%; padding:15px; border:none; margin-top:5px; cursor:pointer;">RETURN TO MENU</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <div id="view-title" class="title-screen glass-panel">
        <div class="hero-logo">üé¥</div>
        <h1 style="font-size: 1.8rem; margin-bottom: 5px;">FLIPMASTER 7</h1>
        <p style="color: var(--subtext); font-size: 0.8rem; margin-bottom: 30px; letter-spacing: 2px;">SCORER</p>
        <button class="menu-btn primary" id="btn-start" onclick="startNewMatch()">Start New Match</button>
        <button class="menu-btn" id="continue-btn" onclick="switchTab('game')" style="display:none;">Continue Match</button>
        <div style="display:flex; gap:10px; width:100%;">
            <button class="menu-btn secondary" onclick="switchTab('stats')" style="flex:1;">History</button>
            <button class="menu-btn secondary" onclick="openRules()" style="flex:1;">üìñ Rules</button>
        </div>
        <button class="menu-btn secondary" onclick="openSettings()" style="width:100%; margin-top:0;">‚öôÔ∏è Settings</button>
        
        <button id="install-btn" class="menu-btn install" onclick="installApp()">‚¨áÔ∏è Install App</button>
        <button class="menu-btn coffee" onclick="window.open('https://buymeacoffee.com/unkieshane', '_blank')">‚òï Buy Unkie Shane a Coffee</button>
        
        <button class="menu-btn danger" onclick="clearRoster()">Clear Roster</button>
    </div>

    <div id="app-main" class="hidden" style="width: 100%; max-width: 480px;">
        <div class="header-row">
            <h1>Scorer</h1>
            <button class="reset-action-btn" onclick="backToTitle()">MENU</button>
        </div>
        <div class="tab-container">
            <button class="tab-btn active" id="tab-game-btn" onclick="switchTab('game')">SCORES</button>
            <button class="tab-btn" id="tab-calc-btn" onclick="switchTab('calc')">CALC</button>
            <button class="tab-btn" id="tab-stats-btn" onclick="switchTab('stats')">LOG</button>
        </div>
        
        <div id="view-game" class="glass-panel">
            <div id="players"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <input type="text" id="pname" placeholder="Name..." style="flex:1;" onkeydown="if(event.key === 'Enter') addP()">
                <button onclick="addP()" style="background:var(--gold); color:#000; border:none; padding:0 20px; border-radius:12px; font-weight:bold; font-size:1.5rem;">+</button>
            </div>
            <button class="submit-btn" onclick="calc()">SUBMIT ROUND</button>
        </div>

        <div id="view-calc" class="glass-panel hidden">
            <div style="text-align:center; font-size: 3.5rem; font-weight: 900; margin-bottom:10px; display:flex; align-items:center; justify-content:center; gap:10px;">
                <span id="calc-res" style="color:var(--gold)">0</span>
                <span id="calc-bonus-res" style="font-size:1.5rem; color:var(--bonus-green); display:none;">+0</span>
            </div>
            <div id="token-grid" class="token-grid"></div>
            <div style="text-align:center; margin-top:20px; margin-bottom:5px; color:#aaa; font-size:0.8rem; font-weight:bold;">BONUS CARDS (Not X2)</div>
            <div id="bonus-grid" class="bonus-row"></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                 <button onclick="cClear()" style="flex:1; background:rgba(255,255,255,0.05); color:#fff; border:1px solid rgba(255,255,255,0.1); padding:15px; border-radius:15px; font-weight:bold;">CLR</button>
            </div>
            <div id="send-player-list" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;"></div>
        </div>

        <div id="view-stats" class="glass-panel hidden">
            <button onclick="backToTitle()" style="width:100%; background:rgba(255,255,255,0.05); color:#fff; border:none; padding:10px; border-radius:10px; margin-bottom:15px; font-size:0.7rem;">‚Üê BACK</button>
            <div id="stats-content"></div>
        </div>
    </div>

    <script>
        // Data Init
        let data = JSON.parse(localStorage.getItem('unkie_f7_local')) || {p:[], m:[], round:1, keepAwake: false, sound: true, haptics: true, dealerIdx: 0};
        if(typeof data.dealerIdx === 'undefined') data.dealerIdx = 0;
        if(typeof data.sound === 'undefined') data.sound = true;
        if(typeof data.haptics === 'undefined') data.haptics = true;
        data.p.forEach(p => { if(typeof p.bonusVal === 'undefined') p.bonusVal = 0; });

        let currentTotal = 0;
        let currentBonus = 0;
        let confirmCallback = null;
        let wakeLockSentinel = null;
        let backupState = null;
        let deferredPrompt = null;
        
        // Sound Context
        let audioCtx = null;

        const save = () => localStorage.setItem('unkie_f7_local', JSON.stringify(data));

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        /* --- SOUND ENGINE --- */
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(type) {
            if (!data.sound) return;
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            
            if (type === 'click') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } 
            else if (type === 'bust') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.4);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            }
            else if (type === 'win') {
                // Arpeggio
                [440, 554, 659, 880].forEach((freq, i) => {
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    o.connect(g); g.connect(audioCtx.destination);
                    o.type = 'triangle';
                    o.frequency.value = freq;
                    g.gain.setValueAtTime(0.1, now + i*0.1);
                    g.gain.exponentialRampToValueAtTime(0.01, now + i*0.1 + 0.3);
                    o.start(now + i*0.1); o.stop(now + i*0.1 + 0.3);
                });
            }
        }

        function toggleSound() {
            data.sound = !data.sound;
            save(); renderSettingsUI();
            if(data.sound) playSound('click');
        }

        /* --- HAPTICS ENGINE --- */
        function triggerHaptic(type) {
            if (!data.haptics || !navigator.vibrate) return;
            const duration = (type === 'heavy') ? 40 : 8; 
            navigator.vibrate(duration);
        }

        function toggleHaptics() {
            data.haptics = !data.haptics;
            save(); renderSettingsUI();
            if(data.haptics) triggerHaptic('heavy');
        }

        /* --- CONFETTI ENGINE --- */
        let confettiActive = false;
        function startConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            canvas.style.display = 'block';
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const ctx = canvas.getContext('2d');
            const particles = [];
            const colors = ['#ffcc00', '#ff2a2a', '#00e676', '#2979ff', '#d500f9'];

            for(let i=0; i<100; i++) {
                particles.push({
                    x: Math.random() * canvas.width, y: Math.random() * -canvas.height,
                    vx: Math.random() * 4 - 2, vy: Math.random() * 5 + 2,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 8 + 4
                });
            }

            confettiActive = true;
            function loop() {
                if(!confettiActive) { ctx.clearRect(0,0,canvas.width,canvas.height); return; }
                ctx.clearRect(0,0,canvas.width,canvas.height);
                particles.forEach(p => {
                    p.x += p.vx; p.y += p.vy;
                    if(p.y > canvas.height) p.y = -10;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, p.size, p.size);
                });
                requestAnimationFrame(loop);
            }
            loop();
        }

        function stopConfetti() {
            confettiActive = false;
            document.getElementById('confetti-canvas').style.display = 'none';
        }

        /* --- PWA INSTALL --- */
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('install-btn');
            if(btn) btn.style.display = 'block';
        });

        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('install-btn').style.display = 'none';
                }
                deferredPrompt = null;
            }
        }

        /* --- WAKE LOCK --- */
        async function applyWakeLock() {
            if (!('wakeLock' in navigator)) return;
            try {
                if(data.keepAwake && document.visibilityState === 'visible') {
                    wakeLockSentinel = await navigator.wakeLock.request('screen');
                }
            } catch (err) { console.log(err); }
        }

        async function toggleWakeLock() {
            if (!('wakeLock' in navigator)) {
                showToast("Not supported");
                return;
            }
            data.keepAwake = !data.keepAwake;
            save();
            renderSettingsUI();
            if (data.keepAwake) {
                await applyWakeLock();
                showToast("Screen Lock: ON");
            } else {
                if (wakeLockSentinel) {
                    await wakeLockSentinel.release();
                    wakeLockSentinel = null;
                }
                showToast("Screen Lock: OFF");
            }
        }

        document.addEventListener('visibilitychange', async () => {
            if (wakeLockSentinel !== null && document.visibilityState === 'visible') {
                await applyWakeLock();
            }
        });

        /* --- UI LOGIC --- */
        function openSettings() {
            renderSettingsUI();
            document.getElementById('settings-modal').classList.add('show');
        }
        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('show');
        }
        function renderSettingsUI() {
            const wakeBtn = document.getElementById('wakelock-btn');
            if (data.keepAwake) { wakeBtn.classList.add('active'); wakeBtn.innerText = "ON"; } 
            else { wakeBtn.classList.remove('active'); wakeBtn.innerText = "OFF"; }

            const soundBtn = document.getElementById('sound-btn');
            if (data.sound) { soundBtn.classList.add('active'); soundBtn.innerText = "ON"; }
            else { soundBtn.classList.remove('active'); soundBtn.innerText = "OFF"; }

            const hapticBtn = document.getElementById('haptic-btn');
            if (data.haptics) { hapticBtn.classList.add('active'); hapticBtn.innerText = "ON"; }
            else { hapticBtn.classList.remove('active'); hapticBtn.innerText = "OFF"; }
        }
        
        function openRules() { document.getElementById('rules-modal').classList.add('show'); }
        function closeRules() { document.getElementById('rules-modal').classList.remove('show'); }

        function openConfirm(message, callback) {
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-modal').classList.add('show');
            confirmCallback = callback;
        }
        function resolveConfirm(result) {
            document.getElementById('confirm-modal').classList.remove('show');
            if (confirmCallback) {
                const cb = confirmCallback; confirmCallback = null; cb(result);
            }
        }

        function setDealer(i) {
            triggerHaptic();
            if (data.dealerIdx === i) {
                data.dealerIdx++;
                if (data.dealerIdx >= data.p.length) data.dealerIdx = 0;
            } else {
                data.dealerIdx = i;
            }
            save();
            render();
        }

        /* --- GAME LOGIC --- */
        function startNewMatch() {
            triggerHaptic('heavy');
            document.getElementById('winner-modal').classList.remove('show');
            const hasScores = data.p.some(p => p.s > 0);
            const doStart = () => {
                data.p.forEach(p => { 
                    p.s = 0; p.bCount = 0; p.x2 = false; p.f7 = false; 
                    p.busted = false; p.curVal = ""; p.bonusVal = 0; p.prevData = null; 
                });
                data.round = 1; save(); switchTab('game');
            };
            if(hasScores) { openConfirm("Reset all scores to 0?", (yes) => { if(yes) doStart(); }); } else { doStart(); }
        }

        function clearRoster() {
            triggerHaptic('heavy');
            openConfirm("Delete ALL players?", (yes) => {
                if(yes) {
                    data.p = []; data.dealerIdx = 0; save(); render();
                    showToast("Roster Cleared"); checkContinueStatus();
                }
            });
        }

        function backToTitle() {
            syncInputs();
            document.getElementById('app-main').classList.add('hidden');
            document.getElementById('view-title').classList.remove('hidden');
            checkContinueStatus();
        }

        function checkContinueStatus() {
            const hasPlayers = data.p.length > 0;
            document.getElementById('continue-btn').style.display = hasPlayers ? 'block' : 'none';
            document.getElementById('btn-start').innerText = hasPlayers ? 'Reset Scores' : 'Start New Match';
        }

        function switchTab(tab) {
            triggerHaptic();
            if(!document.getElementById('view-game').classList.contains('hidden')) syncInputs();
            document.getElementById('view-title').classList.add('hidden');
            document.getElementById('app-main').classList.remove('hidden');
            document.querySelectorAll('.glass-panel').forEach(c => { 
                if(c.id !== 'view-title' && c.id !== 'app-main') c.classList.add('hidden'); 
            });
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}-btn`).classList.add('active');
            if(tab === 'calc') renderCalc();
            if(tab === 'stats') renderStats();
            if(tab === 'game') render(); 
        }

        function cAdd(v) { playSound('click'); triggerHaptic(); currentTotal += v; updateCalcDisplay(); }
        function cAddBonus(v) { playSound('click'); triggerHaptic(); currentBonus += v; updateCalcDisplay(); }
        function cClear() { triggerHaptic(); currentTotal = 0; currentBonus = 0; updateCalcDisplay(); }
        
        function updateCalcDisplay() { 
            document.getElementById('calc-res').innerText = currentTotal; 
            const b = document.getElementById('calc-bonus-res');
            if(currentBonus > 0) {
                b.style.display = "block";
                b.innerText = `+${currentBonus}`;
            } else {
                b.style.display = "none";
            }
        }

        function sendToSpecific(i) {
            triggerHaptic('heavy');
            data.p[i].curVal = currentTotal.toString();
            data.p[i].bonusVal = currentBonus;
            cClear(); save();
            document.getElementById('view-calc').classList.add('hidden');
            document.getElementById('view-game').classList.remove('hidden');
            document.getElementById('tab-calc-btn').classList.remove('active');
            document.getElementById('tab-game-btn').classList.add('active');
            render();
        }

        // --- CSS CARD GENERATOR (NEON) ---
        function getCardHTML(val, isBonus) {
            const colors = {
                12: '#ff2a2a', 11: '#ff9100', 10: '#ffd600', 9: '#00e676', 8: '#2979ff',
                7: '#d500f9', 6: '#f50057', 5: '#00bfa5', 4: '#8d6e63', 3: '#78909c',
                2: '#bdbdbd', 1: '#ffffff'
            };
            
            let color = isBonus ? 'var(--bonus-green)' : (colors[val] || '#444');
            let displayVal = isBonus ? `+${val}` : val;
            let cardClass = isBonus ? 'bonus' : 'number';

            return `
            <div class="slick-card ${cardClass}" style="--c-bg: ${color};" onclick="${isBonus ? `cAddBonus(${val})` : `cAdd(${val})`}">
                <div class="card-corner">${displayVal}</div>
                <div class="card-center">${displayVal}</div>
                <div class="card-corner btm">${displayVal}</div>
            </div>`;
        }

        function renderCalc() {
            const vals = [12,11,10,9,8,7,6,5,4,3,2,1];
            document.getElementById('token-grid').innerHTML = vals.map(v => getCardHTML(v, false)).join('');
            
            const bonuses = [2,4,6,8,10];
            document.getElementById('bonus-grid').innerHTML = bonuses.map(v => getCardHTML(v, true)).join('');
            
            document.getElementById('send-player-list').innerHTML = data.p.map((p, i) => 
                `<button class="menu-btn" style="padding:15px; border-color:var(--gold); color:var(--gold); margin:0;" onclick="sendToSpecific(${i})">${p.name}</button>`
            ).join('');
            cClear(); 
        }

        function syncInputs() {
            data.p.forEach((p, i) => {
                const el = document.getElementById(`i${i}`);
                if (el) p.curVal = el.value;
            });
            save();
        }

        function saveInput(i, val) {
            data.p[i].curVal = val;
            save();
        }

        function clearBonus(i) {
            triggerHaptic();
            data.p[i].bonusVal = 0;
            save();
            render();
        }

        function addP() {
            triggerHaptic();
            syncInputs();
            const n = document.getElementById('pname');
            const name = n.value.trim();
            if(name) { 
                data.p.push({name: name, s: 0, bCount: 0, x2: false, f7: false, busted: false, curVal: "", bonusVal: 0}); 
                n.value = ""; 
                save(); 
                render(); 
            }
        }

        function triggerRemoveP(i) {
            triggerHaptic('heavy');
            syncInputs();
            openConfirm(`Remove ${data.p[i].name}?`, (yes) => {
                if(yes) {
                    data.p.splice(i, 1);
                    if(i < data.dealerIdx) data.dealerIdx--;
                    if(data.dealerIdx >= data.p.length) data.dealerIdx = 0;
                    save();
                    render();
                }
            });
        }

        function toggleOpt(i, opt) { 
            triggerHaptic();
            syncInputs(); data.p[i][opt] = !data.p[i][opt]; save(); render(); 
        }

        function bustPlayer(i) {
            syncInputs();
            const p = data.p[i];
            if(!p.busted) {
                playSound('bust');
                triggerHaptic('heavy');
                p.prevData = { val: p.curVal, bonus: p.bonusVal, x2: p.x2, f7: p.f7 };
                p.busted = true; p.bCount++; p.x2 = false; p.f7 = false; p.curVal = ""; p.bonusVal = 0;
            } else {
                triggerHaptic();
                p.busted = false; p.bCount--;
                if(p.prevData) {
                    p.curVal = p.prevData.val; p.bonusVal = p.prevData.bonus || 0; 
                    p.x2 = p.prevData.x2; p.f7 = p.prevData.f7;
                }
            }
            save(); render();
        }

        function calc() {
            triggerHaptic('heavy');
            syncInputs();
            backupState = JSON.parse(JSON.stringify(data));
            let winner = null, roundActivity = false;
            data.p.forEach((p) => {
                if(p.busted) { p.busted = false; roundActivity = true; return; }
                let base = parseInt(p.curVal) || 0;
                let bonus = p.bonusVal || 0;
                if(p.curVal !== "" || bonus > 0 || p.f7) {
                    let score = p.x2 ? base * 2 : base;
                    score += bonus;
                    if(p.f7) score += 15;
                    p.s += score;
                    roundActivity = true;
                }
                if(p.s >= 200 && (!winner || p.s > winner.s)) winner = p;
                p.x2 = false; p.f7 = false; p.curVal = ""; p.bonusVal = 0; p.prevData = null;
            });
            if(roundActivity) {
                data.round++; 
                if (data.p.length > 0) { data.dealerIdx++; if (data.dealerIdx >= data.p.length) data.dealerIdx = 0; }
                save(); render();
                if(winner) showWinner(winner); else showToast("Round " + data.round);
            } else { showToast("No scores entered"); }
        }

        function showWinner(w) {
            playSound('win');
            startConfetti();
            data.m.unshift({name: w.name, score: w.s, date: new Date().toLocaleDateString()});
            if(data.m.length > 10) data.m.pop();
            save();
            document.getElementById('winner-display-name').innerText = w.name;
            document.getElementById('winner-score-display').innerText = `${w.s} Pts!`;
            document.getElementById('winner-modal').classList.add('show');
        }

        function closeWinnerModal() { 
            stopConfetti();
            document.getElementById('winner-modal').classList.remove('show');
            setTimeout(() => backToTitle(), 300);
        }

        function undoWin() {
            if(!backupState) { showToast("Cannot undo"); return; }
            triggerHaptic('heavy');
            data = JSON.parse(JSON.stringify(backupState));
            save(); render();
            stopConfetti();
            document.getElementById('winner-modal').classList.remove('show');
            showToast("Round Undone");
        }

        function renderStats() {
            let html = `<div style="color:var(--gold); font-weight:900; margin-bottom:15px;">SESSION BUSTS</div>`;
            html += data.p.map(p => `<div>${p.name}: <span style="color:var(--bust-red)">${p.bCount}</span></div>`).join('');
            html += `<div style="color:var(--gold); font-weight:900; margin-top:30px;">MATCH HISTORY</div>`;
            html += data.m.length ? data.m.map(m => `<div style="padding:5px; border-bottom:1px solid #333; display:flex; justify-content:space-between;"><span>${m.name}</span> <span style="color:var(--gold)">${m.score}</span></div>`).join('') : '<div style="color:#666">No matches recorded</div>';
            document.getElementById('stats-content').innerHTML = html;
        }

        function render() {
            const max = Math.max(...data.p.map(p => p.s), 0);
            document.getElementById('players').innerHTML = data.p.map((p, i) => `
                <div class="${p.busted ? 'is-busted-wrapper' : ''}" style="margin-bottom:15px;">
                    <div class="player-row ${max > 0 && p.s === max ? 'leader' : ''}">
                        <div class="p-header">
                            <div class="p-info">
                                <div class="dealer-marker ${i === data.dealerIdx ? 'active' : ''}" onclick="setDealer(${i})">D</div>
                                <div>
                                    <small style="color:#888; text-transform:uppercase; font-size:0.7rem; font-weight:bold;">${p.name}</small>
                                    <div class="score">${p.s}</div>
                                </div>
                            </div>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <button class="bust-btn ${p.busted ? 'undo-bust' : ''}" onclick="bustPlayer(${i})">${p.busted ? 'UN-BUST' : 'BUST'}</button>
                                <div style="display:flex; align-items:center;">
                                    <input type="number" inputmode="numeric" pattern="[0-9]*" id="i${i}" placeholder="0" value="${p.curVal}" oninput="saveInput(${i}, this.value)">
                                    ${p.bonusVal > 0 ? `<div class="bonus-badge" onclick="clearBonus(${i})">+${p.bonusVal}</div>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="action-group">
                            <button class="opt-btn ${p.x2 ? 'active-x2' : ''}" onclick="toggleOpt(${i}, 'x2')">X2</button>
                            <button class="opt-btn ${p.f7 ? 'active-f7' : ''}" onclick="toggleOpt(${i}, 'f7')">Flip 7</button>
                            <button class="opt-btn delete-btn" onclick="triggerRemoveP(${i})">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        if(data.keepAwake) applyWakeLock();
        checkContinueStatus();
    </script>
</body>
</html>
